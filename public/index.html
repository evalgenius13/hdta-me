<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>How the News Affects You</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='black'/><text x='50%' y='60%' text-anchor='middle' font-size='42' fill='white' font-family='system-ui'>HD</text></svg>">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:Georgia,"Times New Roman",serif;background:#fafafa;color:#111;line-height:1.6}
    .wrap{max-width:640px;margin:0 auto;padding:0 16px}

    .masthead{background:#fff;border-bottom:1px solid #e5e5e5;padding:24px 0 14px}
    .brand{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;font-size:32px;line-height:1.1;font-weight:800;text-align:center;letter-spacing:.2px}
    .tagline{text-align:center;font-size:15px;color:#64748b;margin-top:6px}
    .edition-info{text-align:center;color:#6b7280;font-size:12px;margin-top:8px;text-transform:uppercase;letter-spacing:.06em}

    .main-content{padding:16px 0}
    .articles-list{max-width:640px;margin:4px auto 0}
    .article-item{background:#fff;padding:0 0 16px}
    .articles-list>article+article{border-top:1px solid #e5e5e5;padding-top:16px;margin-top:16px}

    .news-image{width:100%;height:160px;background:#f8f9fa;display:flex;align-items:center;justify-content:center;color:#666;font-size:1rem;overflow:hidden}
    .news-image img{width:100%;height:100%;object-fit:cover;object-position:center}

    .article-content{padding:12px 0}
    .article-meta{color:#6b7280;font-size:.9rem;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
    .read-full{color:#0ea5e9;text-decoration:none;font-weight:600;font-size:.9rem}
    .read-full:hover{text-decoration:underline}
    .article-title{font-size:20px;font-weight:700;color:#111;margin-bottom:8px;line-height:1.35}
    .article-summary{color:#1f2937;font-size:16px;line-height:1.6;margin-bottom:12px}

    .analysis{border-top:1px solid #e5e5e5;margin-top:12px;padding-top:12px}
    .analysis-section{margin-bottom:16px}
    .analysis-section:last-child{margin-bottom:0}
    .analysis-label{font-size:14px;letter-spacing:.06em;text-transform:uppercase;color:#111;margin-bottom:8px;font-weight:700;border-bottom:2px solid #0ea5e9;padding-bottom:4px}
    .analysis-text{font-size:16px;line-height:1.7;color:#1f2937}
    .analysis-text p{margin-bottom:12px}
    .analysis-text p:last-child{margin-bottom:0}

    .loading-state{text-align:center;padding:36px 16px;color:#64748b;font-style:italic}
    .loading-spinner{width:16px;height:16px;border:2px solid #e2e8f0;border-top:2px solid #0ea5e9;border-radius:50%;animation:spin 1s linear infinite;display:inline-block;margin-right:8px;vertical-align:-3px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    .no-analysis{color:#64748b;font-style:italic;padding:12px;background:#f8f9fa;border-radius:6px}

    .newsletter-signup{background:#fff;margin-top:32px;padding:24px 0;border-top:1px solid #e5e5e5}
    .signup-container{text-align:center;max-width:400px;margin:0 auto}
    .signup-title{font-size:18px;font-weight:700;color:#111;margin-bottom:8px;line-height:1.3}
    .signup-form{margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    .signup-email{flex:1;min-width:200px;padding:12px;border:1px solid #d1d5db;border-radius:6px;font-size:16px;font-family:inherit}
    .signup-btn{background:#0ea5e9;color:#fff;padding:12px 20px;border:none;border-radius:6px;font-size:16px;font-weight:600;cursor:pointer;white-space:nowrap}
    .signup-btn:hover{background:#0284c7}
    .signup-btn:disabled{background:#9ca3af;cursor:not-allowed}

    .footer{background:#fafafa;padding:20px 0;border-top:1px solid #e5e5e5;margin-top:20px}
    .footer-text{text-align:center;font-size:12px;color:#6b7280;font-family:system-ui,-apple-system,sans-serif}
  </style>
</head>
<body>
  <header class="masthead">
    <div class="wrap">
      <h1 class="brand">How the News Affects You</h1>
      <p class="tagline">Form headline to real life</p>
      <div class="edition-info" id="edition-info">Loading...</div>
    </div>
  </header>

  <main class="main-content">
    <div class="wrap">
      <div class="loading-state" id="loading">
        <span class="loading-spinner"></span>
        Loading today's analysis...
      </div>
      <div class="articles-list" id="articles-container" style="display:none"></div>
    </div>

    <div class="newsletter-signup">
      <div class="wrap">
        <div class="signup-container">
          <h3 class="signup-title">See How the News Affects You Every Morning</h3>
          <form class="signup-form" onsubmit="return false;">
            <input 
              type="email" 
              class="signup-email"
              placeholder="Enter your email"
              required
            >
            <button type="submit" class="signup-btn">Subscribe</button>
          </form>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    <div class="wrap">
      <div class="footer-text">Â© 2025 How the News Affects Youâ„¢. All rights reserved.</div>
    </div>
  </footer>

  <script>
    class DailyNewsletterSite {
      constructor(){ 
        this.articles=[];  
        this.API_BASE = '';  // Use relative URLs for same domain
        this.init(); 
      }

      async init(){ await this.fetchTodaysContent(); }

      async fetchTodaysContent(){
        try{
          const response=await fetch('/api/fetch-news');  // Relative URL
          if(!response.ok) throw new Error(`HTTP ${response.status}`);
          const data=await response.json();
          if(data.articles){
            this.articles=data.articles.slice(0,6);
            if(data.edition_info) this.updateEditionInfo(data.edition_info);
            this.displayArticles();
          } else { throw new Error('No articles'); }
        }catch(e){
          console.error('Error fetching articles:',e);
          document.getElementById('loading').innerHTML='Unable to load today\'s analysis. Please refresh.';
        }
      }

      updateEditionInfo(editionInfo){
        const today=new Date();
        const options={weekday:'long',year:'numeric',month:'long',day:'numeric'};
        const dateStr=today.toLocaleDateString('en-US',options);
        const statusText=editionInfo.is_automated ? (editionInfo.is_today ? '' : ' (Latest Edition)') : ' (Live Updates)';
        document.getElementById('edition-info').textContent=`${dateStr} â€¢ Issue #${editionInfo.issue_number}${statusText}`;
      }

      displayArticles(){
        const container=document.getElementById('articles-container');
        const loading=document.getElementById('loading');
        if(this.articles.length===0){ loading.innerHTML='No policy stories today.'; return; }
        loading.style.display='none'; container.style.display='block';
        container.innerHTML=this.articles.map((a,i)=>this.createArticleHTML(a,i)).join('');
        
        // Display structured analysis for each article
        for(let i=0;i<this.articles.length;i++){
          this.showStructuredAnalysis(i);
        }
      }

      createArticleHTML(article,index){
        const timeAgo=this.getTimeAgo(article.publishedAt);
        const cleanTitle=this.cleanTitle(article.title);
        return `
        <article class="article-item" onclick="window.open('${article.url}','_blank')">
          <div class="news-image">
            ${article.urlToImage||article.image ? `<img src="${article.urlToImage||article.image}" alt="News image" onerror="this.parentElement.innerHTML='ðŸ“°'">` : 'ðŸ“°'}
          </div>
          <div class="article-content">
            <div class="article-meta">
              <span>${this.escapeHtml(article.source?.name||'News Source')} â€¢ ${timeAgo}</span>
              <a href="${article.url}" class="read-full" target="_blank" onclick="event.stopPropagation()">Read full story â†’</a>
            </div>
            <h3 class="article-title">${this.escapeHtml(cleanTitle)}</h3>
            <p class="article-summary">${this.escapeHtml(article.description||'')}</p>

            <div class="analysis" id="analysis-container-${index}">
              <!-- Analysis sections will be inserted here -->
            </div>

          </div>
        </article>`;
      }

      showStructuredAnalysis(index){
        const article = this.articles[index];
        const container = document.getElementById(`analysis-container-${index}`);
        
        if (!container) return;

        // Check if we have structured sections
        const hasStructured = article.whatsHappening || article.affectsMe;
        
        if (hasStructured) {
          // Display structured sections with headlines
          let html = '';
          
          if (article.whatsHappening) {
            html += `
              <div class="analysis-section">
                <div class="analysis-label">What's Happening Here?</div>
                <div class="analysis-text">${this.formatAnalysisText(article.whatsHappening)}</div>
              </div>
            `;
          }
          
          if (article.affectsMe) {
            html += `
              <div class="analysis-section">
                <div class="analysis-label">How Does This Affect Me?</div>
                <div class="analysis-text">${this.formatAnalysisText(article.affectsMe)}</div>
              </div>
            `;
          }
          
          container.innerHTML = html;
          
        } else if (article.preGeneratedAnalysis) {
          // Fallback to old format for articles without structured sections
          container.innerHTML = `
            <div class="analysis-section">
              <div class="analysis-label">What's Happening Here?</div>
              <div class="analysis-text">${this.formatAnalysisText(article.preGeneratedAnalysis)}</div>
            </div>
          `;
          
        } else {
          // No analysis available
          container.innerHTML = `
            <div class="analysis-section">
              <div class="analysis-label">What's Happening Here?</div>
              <div class="analysis-text">
                <div class="no-analysis">Analysis coming soon - check back for updates to this story.</div>
              </div>
            </div>
          `;
        }
      }

      formatAnalysisText(text) {
        if (!text || text === 'No analysis available') {
          return '<div class="no-analysis">Analysis coming soon - check back for updates to this story.</div>';
        }
        
        // Convert text to paragraphs
        return text.split('\n\n').filter(p => p.trim()).map(p => `<p>${this.escapeHtml(p.trim())}</p>`).join('');
      }

      cleanTitle(t){ if(!t) return ''; return t.replace(/^(BREAKING|LIVE|UPDATE|ALERT):\s*/i,''); }

      getTimeAgo(p){
        if(!p) return 'Recently';
        const now=new Date(), pub=new Date(p); const hrs=Math.floor((now-pub)/3600000); const days=Math.floor(hrs/24);
        if(hrs<1) return 'Just published'; if(hrs<24) return `${hrs}h ago`; if(days===1) return 'Yesterday'; if(days<7) return `${days} days ago`;
        return pub.toLocaleDateString();
      }

      escapeHtml(t){ if(!t) return ''; const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }
    }

    document.addEventListener('DOMContentLoaded',()=>{ window.dailyNewsletter=new DailyNewsletterSite(); });
  </script>
</body>
</html>
