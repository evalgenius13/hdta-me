<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HDTA Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui; background: #f8fafc; color: #1f2937; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .actions { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 12px; }
        .btn { background: #3b82f6; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: #2563eb; }
        .btn-danger { background: #dc2626; }
        
        .article-grid { display: grid; gap: 16px; }
        .article-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; }
        .article-header { padding: 16px; border-bottom: 1px solid #f3f4f6; }
        .article-title { font-weight: 600; font-size: 16px; }
        .article-meta { font-size: 12px; color: #6b7280; margin-top: 4px; }
        .article-content { padding: 16px; }
        .article-description { color: #4b5563; font-size: 14px; margin-bottom: 12px; }
        .analysis-content { background: #f9fafb; padding: 12px; border-radius: 6px; font-size: 14px; }
        .article-actions { padding: 12px 16px; background: #f9fafb; display: flex; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        
        .loading { text-align: center; padding: 40px; color: #6b7280; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 16px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-label { font-size: 12px; color: #6b7280; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>HDTA Admin</h1>
            <div id="edition-info">Loading...</div>
        </div>

        <div class="actions">
            <button class="btn" onclick="regenerate()">üîÑ Regenerate</button>
            <button class="btn" onclick="refetch()">üöÄ Force Refetch</button>
            <button class="btn" onclick="refresh()">üîÑ Refresh</button>
            <button class="btn btn-danger" onclick="clear()">üóëÔ∏è Clear</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">--</div>
                <div class="stat-label">Total Articles</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-analyzed">--</div>
                <div class="stat-label">Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-success">--</div>
                <div class="stat-label">Success Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-status">--</div>
                <div class="stat-label">Status</div>
            </div>
        </div>

        <div class="loading" id="loading">Loading articles...</div>
        <div class="article-grid" id="articles" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = 'https://hdta-me.vercel.app';
        const ADMIN_KEY = 'hdta-admin-2025-temp';
        let articles = [];

        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/api/admin?action=get-articles`, {
                    headers: { 'Authorization': `Bearer ${ADMIN_KEY}` }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                articles = data.articles || [];
                
                if (data.edition) {
                    document.getElementById('edition-info').textContent = 
                        `Issue #${data.edition.issue_number} ‚Ä¢ ${data.edition.date}`;
                }
                
                renderArticles();
                updateStats();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('articles').style.display = 'grid';
                
            } catch (error) {
                console.error('Failed to load:', error);
                document.getElementById('loading').innerHTML = 
                    `<div style="color: #dc2626;">Failed to load: ${error.message}</div>`;
            }
        }

        function renderArticles() {
            const grid = document.getElementById('articles');
            
            if (articles.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #6b7280;">No articles found</div>';
                return;
            }
            
            grid.innerHTML = articles.map((article, index) => `
                <div class="article-card">
                    <div class="article-header">
                        <div class="article-title">${escapeHtml(article.title || '')}</div>
                        <div class="article-meta">
                            ${escapeHtml(article.source?.name || 'Unknown')} ‚Ä¢ 
                            Status: ${article.status || 'queue'} ‚Ä¢ 
                            Order: ${article.order || '--'}
                        </div>
                    </div>
                    <div class="article-content">
                        <div class="article-description">
                            ${escapeHtml(article.description || '')}
                        </div>
                        <div class="analysis-content">
                            ${escapeHtml(article.preGeneratedAnalysis || 'No analysis')}
                        </div>
                    </div>
                    <div class="article-actions">
                        <button class="btn btn-small" onclick="regenerateOne(${index})">üîÑ Regenerate</button>
                        <button class="btn btn-small" onclick="window.open('${escapeHtml(article.url || '')}', '_blank')">üîó View</button>
                        <button class="btn btn-small btn-danger" onclick="removeArticle(${index})">üóëÔ∏è Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            const analyzed = articles.filter(a => a.preGeneratedAnalysis).length;
            const successRate = articles.length > 0 ? Math.round((analyzed / articles.length) * 100) : 0;
            
            document.getElementById('stat-total').textContent = articles.length;
            document.getElementById('stat-analyzed').textContent = analyzed;
            document.getElementById('stat-success').textContent = `${successRate}%`;
            document.getElementById('stat-status').textContent = articles.length > 0 ? 'Active' : 'Empty';
        }

        async function regenerate() {
            await trigger(false);
        }

        async function refetch() {
            await trigger(true);
        }

        async function trigger(forceRefetch = false) {
            try {
                const response = await fetch(`${API_BASE}/api/manual-trigger`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        trigger_key: 'force-update-2025',
                        force_refetch: forceRefetch
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    await loadData();
                    console.log('Success:', data);
                } else {
                    console.error('Failed:', data.error);
                }
            } catch (error) {
                console.error('Trigger failed:', error);
            }
        }

        async function refresh() {
            await loadData();
        }

        async function clear() {
            if (!confirm('Clear today\'s edition?')) return;
            
            try {
                await fetch(`${API_BASE}/api/admin?action=clear-today`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${ADMIN_KEY}`
                    }
                });
                await loadData();
            } catch (error) {
                console.error('Clear failed:', error);
            }
        }

        async function regenerateOne(index) {
            const article = articles[index];
            try {
                const response = await fetch(`${API_BASE}/api/personalize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ article })
                });
                
                const data = await response.json();
                if (data.impact) {
                    articles[index].preGeneratedAnalysis = data.impact;
                    renderArticles();
                    updateStats();
                }
            } catch (error) {
                console.error('Regenerate failed:', error);
            }
        }

        function removeArticle(index) {
            if (confirm('Remove this article?')) {
                articles.splice(index, 1);
                renderArticles();
                updateStats();
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
